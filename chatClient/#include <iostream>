#include <iostream>
#include <string>
#include <cstring>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include "json.hpp"

using namespace std;
using json = nlohmann::json;


const std::string SEND_END = "|O@v.e^R|\n";
const std::string server_ip="192.168.10.100";
const std::string server_port = "8888";

class Client{
    private:
        int cSock;
        struct sockaddr_in sAddr;
        string username , password;
    public:
        Client() : cSock(socket(PF_INET , SOCK_STREAM , 0)){}

        ~Client() {
            close(cSock);
        }

        void setUserName(const string& username){
            this->username = username;
        }

        void setPassWord(const string& password){
            this->password = password;
        }

        void connect_server(){
            memset(&sAddr, 0, sizeof(sAddr));

            sAddr.sin_family = PF_INET;
            sAddr.sin_addr.s_addr =inet_addr(server_ip.c_str());
            sAddr.sin_port = htons(stoi(server_port));

            connect(cSock, (struct sockaddr*)&sAddr, sizeof(sAddr));
            cout << "The client sock is " << cSock << endl;
        }

        void send_message(int cSock , json json_data){
            string msg = json_data.dump() + SEND_END;
            send(cSock,msg.c_str(),msg.size() , 0);
        }

        void Login(){
            connect_server();
            json json_data;
            json_data["who"] = cSock;
            json_data["command"] = "LOGIN";
            json_data["username"] = "alexqfmm";
            json_data["passwd"] = "123456";
            send_message(cSock , json_data);
        }

        void Logout() {
            json json_data;
            json_data["who"] = cSock;
            json_data["command"] = "LOGOUT";
            send_message(cSock , json_data);
        }     

        void send_chat_with_somebody(const string& friendName,const string& msg) {
            json json_data;
            json_data["who"] = cSock;
            json_data["command"] = "CHAT";
            json_data["friendname"] = friendName;
            json_data["message"] = msg;
 
            send_message(cSock , json_data);
        }
        
};


int main(int argc, char* argv[]) {

    Client user;

    user.setUserName("alexqfmm");
    user.setPassWord("123456");

    user.Login();

    //user.send_chat_with_somebody("peter" , "HI This is a Test : 1 \n HI This is a Test : 2 \t ,HI This is a Test : 3 \n ,HI This is a Test : 4 \t ,HI This is a Test : 5 \n ,HI This is a Test : 6 \t,HI This is a Test : 7 \n  ,HI This is a Test : 8,HI This is a Test : 9 \n ,HI This is a Test : 10 \t");

    //user.send_chat_with_somebody("peter" , "HI , This is a Test! ");

    user.Logout();
    sleep(5);
    return 0;
}
